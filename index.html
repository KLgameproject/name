<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proxy Client | GitHub Codespace Proxy</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --bg: #0f172a;
      --bg-card: #1e293b;
      --bg-input: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #475569;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 1rem;
      line-height: 1.5;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      padding: 1.5rem 0 2rem;
    }

    h1 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .form-group {
      flex: 1;
      margin-bottom: 0.75rem;
    }

    .form-group.small {
      flex: 0 0 140px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.6rem 0.8rem;
      font-size: 0.9rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
      font-family: inherit;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.85rem;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    input::placeholder, textarea::placeholder {
      color: var(--text-muted);
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      padding-right: 2rem;
    }

    .btn-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    button {
      padding: 0.6rem 1rem;
      font-size: 0.85rem;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-family: inherit;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
    }

    .btn-secondary {
      background: var(--bg-input);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--border);
    }

    .btn-sm {
      padding: 0.4rem 0.6rem;
      font-size: 0.75rem;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.8rem;
      border-radius: 16px;
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }

    .status-connected { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .status-disconnected { background: rgba(239, 68, 68, 0.15); color: var(--error); }
    .status-checking { background: rgba(59, 130, 246, 0.15); color: var(--primary); }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .response-area {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .response-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 0.8rem;
      background: var(--bg-input);
      border-bottom: 1px solid var(--border);
      font-size: 0.8rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .response-meta {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .response-badge {
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .badge-error { background: rgba(239, 68, 68, 0.2); color: var(--error); }
    .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

    .response-content {
      max-height: 400px;
      overflow: auto;
    }

    .response-content pre {
      padding: 1rem;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.8rem;
      line-height: 1.6;
      margin: 0;
    }

    .response-iframe {
      width: 100%;
      height: 400px;
      border: none;
      background: white;
    }

    .tabs {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 0.75rem;
    }

    .tab {
      padding: 0.4rem 0.8rem;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.6rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .help-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.3rem;
    }

    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }

    .collapsible-content {
      display: none;
      margin-top: 0.75rem;
    }

    .collapsible-content.open {
      display: block;
    }

    .toggle-icon {
      transition: transform 0.2s;
      font-size: 0.8rem;
    }

    .toggle-icon.open {
      transform: rotate(180deg);
    }

    .examples-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.5rem;
    }

    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast-success {
      background: var(--success);
      color: white;
    }

    .toast-error {
      background: var(--error);
      color: white;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @media (max-width: 640px) {
      .form-row {
        flex-direction: column;
      }
      
      .form-group.small {
        flex: 1;
      }

      .btn-row {
        flex-direction: column;
      }

      button {
        width: 100%;
        justify-content: center;
      }

      .response-meta {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üåê Codespace Proxy Client</h1>
      <p class="subtitle">Proxy requests through your GitHub Codespace</p>
    </header>

    <!-- Server Configuration -->
    <div class="card">
      <div class="card-title">‚öôÔ∏è Server Configuration</div>
      <div class="form-group">
        <label for="proxyUrl" id="proxyUrl-label">Codespace Proxy URL</label>
        <input 
          type="url" 
          id="proxyUrl" 
          placeholder="https://your-codespace-3000.app.github.dev"
          aria-labelledby="proxyUrl-label"
          aria-describedby="proxyUrl-help"
        >
        <p class="help-text" id="proxyUrl-help">Get this from Codespace Ports tab (port 3000, set to Public)</p>
      </div>
      <div class="btn-row" role="group" aria-label="Connection actions">
        <button class="btn-primary" onclick="saveAndTest()" aria-label="Save URL and test connection">üíæ Save & Test</button>
        <button class="btn-secondary" onclick="checkConnection()" aria-label="Test connection only">üîç Test Connection</button>
      </div>
      <div id="connectionStatus" role="status" aria-live="polite"></div>
    </div>

    <!-- Request Builder -->
    <div class="card">
      <div class="card-title">üîó Request Builder</div>
      
      <div class="form-row">
        <div class="form-group small">
          <label for="method">Method</label>
          <select id="method" onchange="toggleBodyInput()" aria-label="HTTP method">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="PATCH">PATCH</option>
            <option value="DELETE">DELETE</option>
            <option value="HEAD">HEAD</option>
          </select>
        </div>
        <div class="form-group">
          <label for="targetUrl">Target URL</label>
          <input 
            type="url" 
            id="targetUrl" 
            placeholder="https://api.github.com/users/octocat"
            aria-label="Target URL to proxy"
          >
        </div>
      </div>

      <!-- Request Body (collapsible) -->
      <div id="bodySection" style="display: none;">
        <div class="form-group">
          <label for="requestBody">Request Body (JSON)</label>
          <textarea 
            id="requestBody" 
            placeholder='{"key": "value"}'
            aria-label="JSON request body"
          ></textarea>
        </div>
      </div>

      <!-- Headers (collapsible) -->
      <div class="collapsible-header" onclick="toggleSection('headers')" role="button" tabindex="0" aria-expanded="false" aria-controls="headers-content" onkeypress="if(event.key==='Enter')toggleSection('headers')">
        <label style="cursor: pointer; margin: 0;">üìã Custom Headers (optional)</label>
        <span class="toggle-icon" id="headers-icon" aria-hidden="true">‚ñº</span>
      </div>
      <div class="collapsible-content" id="headers-content">
        <textarea 
          id="customHeaders" 
          placeholder='{"Authorization": "Bearer token123"}'
          aria-label="Custom HTTP headers as JSON"
        ></textarea>
        <p class="help-text">JSON object of headers to send with the request</p>
      </div>

      <div class="btn-row" style="margin-top: 1rem;" role="group" aria-label="Request actions">
        <button class="btn-primary" onclick="makeRequest()" id="sendBtn" aria-label="Send proxy request">üöÄ Send Request</button>
        <button class="btn-secondary" onclick="clearAll()" aria-label="Clear all fields">üóëÔ∏è Clear</button>
      </div>
    </div>

    <!-- Response -->
    <div class="card">
      <div class="card-title">üìÑ Response</div>
      <div class="tabs" role="tablist" aria-label="Response view tabs">
        <button class="tab active" onclick="switchTab('raw')" id="tab-raw" role="tab" aria-selected="true" aria-controls="rawContent">Raw</button>
        <button class="tab" onclick="switchTab('formatted')" id="tab-formatted" role="tab" aria-selected="false" aria-controls="formattedContent">Formatted</button>
        <button class="tab" onclick="switchTab('preview')" id="tab-preview" role="tab" aria-selected="false" aria-controls="previewContent">Preview</button>
      </div>
      <div class="response-area">
        <div class="response-header">
          <div class="response-meta" id="responseMeta" aria-live="polite">
            <span>No request sent</span>
          </div>
          <button class="btn-secondary btn-sm" onclick="copyResponse()" aria-label="Copy response to clipboard">üìã Copy</button>
        </div>
        <div class="response-content" id="responseContent">
          <pre id="rawContent" role="tabpanel" aria-labelledby="tab-raw">Send a request to see the response here.</pre>
          <pre id="formattedContent" role="tabpanel" aria-labelledby="tab-formatted" style="display: none;"></pre>
          <iframe 
            id="previewContent" 
            class="response-iframe" 
            style="display: none;" 
            role="tabpanel" 
            aria-labelledby="tab-preview"
            sandbox="allow-same-origin"
            title="Response preview"
          ></iframe>
        </div>
      </div>
    </div>

    <!-- Quick Examples -->
    <div class="card">
      <div class="card-title">‚ö° Quick Examples</div>
      <div class="examples-grid" role="group" aria-label="Quick example buttons">
        <button class="btn-secondary btn-sm" onclick="loadExample('GET', 'https://api.github.com/users/octocat')">GitHub User</button>
        <button class="btn-secondary btn-sm" onclick="loadExample('GET', 'https://jsonplaceholder.typicode.com/posts/1')">JSON Post</button>
        <button class="btn-secondary btn-sm" onclick="loadExample('GET', 'https://httpbin.org/ip')">My IP</button>
        <button class="btn-secondary btn-sm" onclick="loadExample('GET', 'https://httpbin.org/headers')">Headers</button>
        <button class="btn-secondary btn-sm" onclick="loadExample('POST', 'https://httpbin.org/post', '{\"test\": \"data\"}')">POST Test</button>
        <button class="btn-secondary btn-sm" onclick="loadExample('GET', 'https://api.ipify.org?format=json')">Public IP</button>
      </div>
    </div>
  </div>

  <script>
    // Constants
    const REQUEST_TIMEOUT = 60000; // 60 seconds
    const CONNECTION_TIMEOUT = 10000; // 10 seconds

    // State
    let currentTab = 'raw';
    let lastResponse = { raw: '', formatted: '', status: 0 };
    let isLoading = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('proxyUrl');
      if (saved) {
        document.getElementById('proxyUrl').value = saved;
        checkConnection();
      }

      // Enter key triggers send
      document.getElementById('targetUrl').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !isLoading) makeRequest();
      });

      // Enter key on proxy URL saves and tests
      document.getElementById('proxyUrl').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') saveAndTest();
      });
    });

    // Toast notification
    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.setAttribute('role', 'alert');
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // Save and test connection
    function saveAndTest() {
      const url = document.getElementById('proxyUrl').value.trim().replace(/\/+$/, '');
      if (!url) {
        showStatus('Please enter a proxy URL', 'disconnected');
        return;
      }

      // Validate URL format
      try {
        const parsed = new URL(url);
        if (!['http:', 'https:'].includes(parsed.protocol)) {
          showStatus('URL must start with http:// or https://', 'disconnected');
          return;
        }
      } catch {
        showStatus('Invalid URL format', 'disconnected');
        return;
      }

      localStorage.setItem('proxyUrl', url);
      document.getElementById('proxyUrl').value = url;
      checkConnection();
    }

    // Check connection with timeout
    async function checkConnection() {
      const url = document.getElementById('proxyUrl').value.trim();
      if (!url) {
        showStatus('No proxy URL configured', 'disconnected');
        return;
      }

      showStatus('Connecting...', 'checking');

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), CONNECTION_TIMEOUT);

      try {
        const res = await fetch(`${url}/health`, { 
          signal: controller.signal,
          mode: 'cors',
          cache: 'no-store'
        });
        clearTimeout(timeoutId);

        if (res.ok) {
          const data = await res.json();
          showStatus(`Connected (v${data.version || '?'}, up ${formatUptime(data.uptime)})`, 'connected');
        } else {
          showStatus(`Server error: ${res.status} ${res.statusText}`, 'disconnected');
        }
      } catch (err) {
        clearTimeout(timeoutId);
        if (err.name === 'AbortError') {
          showStatus('Connection timeout (10s)', 'disconnected');
        } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
          showStatus('Cannot reach server - check URL and port visibility', 'disconnected');
        } else {
          showStatus(`Failed: ${err.message}`, 'disconnected');
        }
      }
    }

    function formatUptime(seconds) {
      if (!seconds && seconds !== 0) return '?';
      if (seconds < 60) return `${Math.floor(seconds)}s`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
      return `${Math.floor(seconds / 3600)}h`;
    }

    function showStatus(msg, type) {
      const statusEl = document.getElementById('connectionStatus');
      statusEl.innerHTML = `
        <div class="status status-${type}">
          <span class="status-dot" aria-hidden="true"></span>
          <span>${escapeHtml(msg)}</span>
        </div>`;
    }

    // Toggle body input visibility
    function toggleBodyInput() {
      const method = document.getElementById('method').value;
      const hasBody = ['POST', 'PUT', 'PATCH'].includes(method);
      document.getElementById('bodySection').style.display = hasBody ? 'block' : 'none';
    }

    // Toggle collapsible sections
    function toggleSection(id) {
      const content = document.getElementById(`${id}-content`);
      const icon = document.getElementById(`${id}-icon`);
      const header = content.previousElementSibling;
      
      const isOpen = content.classList.toggle('open');
      icon.classList.toggle('open');
      header.setAttribute('aria-expanded', isOpen);
    }

    // Validate URL
    function validateUrl(urlString, fieldName) {
      if (!urlString) {
        return { valid: false, error: `Please enter a ${fieldName}` };
      }

      try {
        const parsed = new URL(urlString);
        if (!['http:', 'https:'].includes(parsed.protocol)) {
          return { valid: false, error: `${fieldName} must use http:// or https://` };
        }
        return { valid: true, url: parsed };
      } catch {
        return { valid: false, error: `Invalid ${fieldName} format` };
      }
    }

    // Make proxy request with timeout
    async function makeRequest() {
      if (isLoading) return;

      const proxyUrl = document.getElementById('proxyUrl').value.trim();
      const targetUrl = document.getElementById('targetUrl').value.trim();
      const method = document.getElementById('method').value;

      // Validate proxy URL
      const proxyValidation = validateUrl(proxyUrl, 'proxy URL');
      if (!proxyValidation.valid) {
        showToast(proxyValidation.error, 'error');
        return;
      }

      // Validate target URL
      const targetValidation = validateUrl(targetUrl, 'target URL');
      if (!targetValidation.valid) {
        showToast(targetValidation.error, 'error');
        return;
      }

      isLoading = true;
      const btn = document.getElementById('sendBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner" style="width:14px;height:14px;margin-right:6px;"></span> Sending...';

      updateResponseMeta('<span>Loading...</span>');
      document.getElementById('rawContent').innerHTML = '<div class="loading"><div class="spinner"></div>Fetching...</div>';

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

      try {
        const fullUrl = `${proxyUrl}/proxy?url=${encodeURIComponent(targetUrl)}`;
        const options = { 
          method, 
          mode: 'cors', 
          headers: {},
          signal: controller.signal,
          cache: 'no-store'
        };

        // Custom headers
        const headersInput = document.getElementById('customHeaders').value.trim();
        if (headersInput) {
          try {
            const parsed = JSON.parse(headersInput);
            if (typeof parsed !== 'object' || Array.isArray(parsed)) {
              throw new Error('Headers must be a JSON object');
            }
            options.headers = { ...options.headers, ...parsed };
          } catch (e) {
            throw new Error(`Invalid headers JSON: ${e.message}`);
          }
        }

        // Request body
        if (['POST', 'PUT', 'PATCH'].includes(method)) {
          const body = document.getElementById('requestBody').value.trim();
          if (body) {
            try {
              JSON.parse(body); // Validate JSON
              options.body = body;
              options.headers['Content-Type'] = 'application/json';
            } catch {
              throw new Error('Invalid JSON in request body');
            }
          }
        }

        const start = performance.now();
        const res = await fetch(fullUrl, options);
        clearTimeout(timeoutId);
        const duration = Math.round(performance.now() - start);

        const contentType = res.headers.get('content-type') || '';
        
        // Read response as text first, then try to parse
        const text = await res.text();
        
        if (contentType.includes('json') || text.trim().startsWith('{') || text.trim().startsWith('[')) {
          try {
            const data = JSON.parse(text);
            lastResponse.raw = text;
            lastResponse.formatted = JSON.stringify(data, null, 2);
          } catch {
            // Not valid JSON, treat as text
            lastResponse.raw = text;
            lastResponse.formatted = text;
          }
        } else {
          lastResponse.raw = text;
          lastResponse.formatted = text;
        }

        lastResponse.status = res.status;
        displayResponse(res.status, duration, contentType);

      } catch (err) {
        clearTimeout(timeoutId);
        
        let errorMessage = err.message;
        if (err.name === 'AbortError') {
          errorMessage = `Request timeout after ${REQUEST_TIMEOUT / 1000} seconds`;
        } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
          errorMessage = 'Network error - check proxy server is running and port is public';
        }

        lastResponse = { raw: errorMessage, formatted: errorMessage, status: 0 };
        updateResponseMeta(`<span class="response-badge badge-error">ERROR</span><span>${escapeHtml(errorMessage)}</span>`);
        document.getElementById('rawContent').textContent = `Error: ${errorMessage}`;
      } finally {
        isLoading = false;
        btn.disabled = false;
        btn.innerHTML = 'üöÄ Send Request';
      }
    }

    function displayResponse(status, duration, contentType) {
      const statusClass = status >= 200 && status < 300 ? 'success' : status >= 400 ? 'error' : 'warning';
      const cleanContentType = (contentType || 'unknown').split(';')[0];
      
      updateResponseMeta(`
        <span class="response-badge badge-${statusClass}">${status}</span>
        <span>${duration}ms</span>
        <span style="color: var(--text-muted)">${escapeHtml(cleanContentType)}</span>
      `);

      document.getElementById('rawContent').textContent = lastResponse.raw;
      document.getElementById('formattedContent').textContent = lastResponse.formatted;

      // Update preview iframe with sandbox for security
      const preview = document.getElementById('previewContent');
      if (contentType && contentType.includes('html')) {
        preview.srcdoc = lastResponse.raw;
      } else {
        preview.srcdoc = `<!DOCTYPE html><html><head><meta charset="utf-8"><style>body{font-family:monospace;padding:1rem;margin:0;white-space:pre-wrap;word-break:break-word;}</style></head><body>${escapeHtml(lastResponse.formatted)}</body></html>`;
      }
    }

    function updateResponseMeta(html) {
      document.getElementById('responseMeta').innerHTML = html;
    }

    // Tab switching
    function switchTab(tab) {
      currentTab = tab;
      
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
      });
      const activeTab = document.getElementById(`tab-${tab}`);
      activeTab.classList.add('active');
      activeTab.setAttribute('aria-selected', 'true');

      // Show/hide content
      document.getElementById('rawContent').style.display = tab === 'raw' ? 'block' : 'none';
      document.getElementById('formattedContent').style.display = tab === 'formatted' ? 'block' : 'none';
      document.getElementById('previewContent').style.display = tab === 'preview' ? 'block' : 'none';
    }

    // Copy response
    async function copyResponse() {
      const text = currentTab === 'formatted' ? lastResponse.formatted : lastResponse.raw;
      if (!text) {
        showToast('No response to copy', 'error');
        return;
      }

      try {
        await navigator.clipboard.writeText(text);
        showToast('Copied to clipboard!', 'success');
      } catch {
        // Fallback for older browsers or non-secure context
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showToast('Copied to clipboard!', 'success');
        } catch {
          showToast('Failed to copy', 'error');
        }
      }
    }

    // Load example
    function loadExample(method, url, body = '') {
      document.getElementById('method').value = method;
      document.getElementById('targetUrl').value = url;
      document.getElementById('requestBody').value = body;
      toggleBodyInput();
    }

    // Clear all
    function clearAll() {
      document.getElementById('targetUrl').value = '';
      document.getElementById('requestBody').value = '';
      document.getElementById('customHeaders').value = '';
      document.getElementById('method').value = 'GET';
      toggleBodyInput();
      lastResponse = { raw: '', formatted: '', status: 0 };
      document.getElementById('rawContent').textContent = 'Send a request to see the response here.';
      document.getElementById('formattedContent').textContent = '';
      document.getElementById('previewContent').srcdoc = '';
      updateResponseMeta('<span>No request sent</span>');
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      if (typeof text !== 'string') return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
